- pipeline: Deploy to Staging
  refs:
  - refs/heads/main
  always_from_scratch: true
  auto_clear_cache: true
  fetch_all_refs: true
  trigger_conditions:
  - trigger_condition: ALWAYS
  actions:
  - action: "Execute: Build static files"
    type: BUILD
    working_directory: /buddy/xendit-components-web
    docker_image_name: library/node
    docker_image_tag: 22
    execute_commands:
    - cp .npmrc.example .npmrc
    - npm install -g pnpm
    - pnpm install
    - pnpm build
    - cp secure-iframe/dist/secure-iframe.html secure-iframe/dist/secure-iframe-$BUDDY_EXECUTION_REVISION_SHORT.html
    - export DYNAMIC_CSP_HASH=$(cat secure-iframe/dist/js-hash.txt)
    - rm -f .npmrc
    shell: BASH
  - action: Upload SDK files to Amazon S3
    type: AMAZON_S3
    input_type: BUILD_ARTIFACTS
    local_path: sdk/dist/
    remote_path: /components/$BUDDY_EXECUTION_REVISION_SHORT/
    bucket_name: xendit-checkout-assets-staging
    acl: PRIVATE
    integration: 5f69e5f01a22366a8e6adfa7
  - action: Upload iframe files to Amazon S3
    type: AMAZON_S3
    input_type: BUILD_ARTIFACTS
    local_path: secure-iframe/dist/secure-iframe-$BUDDY_EXECUTION_REVISION_SHORT.html
    remote_path: /components/
    bucket_name: xendit-checkout-assets-staging
    acl: PRIVATE
    integration: 5f69e5f01a22366a8e6adfa7
  - action: Purge cache at CloudFront
    type: CLOUD_FRONT
    distribution_id: E2BM8Z7S9KCS8C
    purge_by_change_set_limit: 10
    integration: 5f69e5f01a22366a8e6adfa7
    trigger_conditions:
    - trigger_condition: ALWAYS
      timezone: ""
      trigger_hours: []
      trigger_days: []
  - action: Deployment finished notif
    type: SLACK
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME Finished execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    channel: C09L26WCB4J
    attachments:
    - "{\"fallback\":\"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID\",\"color\":\"good\",\"fields\":[{\"title\":\"Successful execution\",\"value\":\"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\",\"short\":true},{\"title\":\"Tag\",\"value\":\"$BUDDY_EXECUTION_TAG\",\"short\":true},{\"title\":\"Project\",\"value\":\"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\",\"short\":true}]}"
    integration: 5ea6524a42eba4000eb35fbb
    trigger_conditions:
    - trigger_condition: ALWAYS
      timezone: ""
      trigger_hours: []
      trigger_days: []
  - action: Deployment failed notif
    type: SLACK
    trigger_time: ON_FAILURE
    content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME Failed execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
    channel: C09L26WCB4J
    attachments:
    - "{\"fallback\":\"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID\",\"color\":\"danger\",\"fields\":[{\"title\":\"Failed execution\",\"value\":\"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>\",\"short\":true},{\"title\":\"Pipeline\",\"value\":\"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>\",\"short\":true},{\"title\":\"Tag\",\"value\":\"$BUDDY_EXECUTION_TAG\",\"short\":true},{\"title\":\"Project\",\"value\":\"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>\",\"short\":true}]}"
    integration: 5ea6524a42eba4000eb35fbb
    trigger_conditions:
    - trigger_condition: ALWAYS
      timezone: ""
      trigger_hours: []
      trigger_days: []
