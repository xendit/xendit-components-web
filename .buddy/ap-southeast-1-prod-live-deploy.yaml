- pipeline: "Deploy to Production"
  trigger_mode: "MANUAL"
  ref_name: '(refs/tags/v\d{0,3}\.\d{0,3}\.\d{0,3}$)'
  ref_type: "WILDCARD"
  priority: "NORMAL"
  always_from_scratch: true
  auto_clear_cache: true
  fetch_all_refs: true
  trigger_condition: "ALWAYS"
  actions:
    - action: "Execute: Build static files"
      type: "BUILD"
      working_directory: "/buddy/xendit-components-web"
      docker_image_name: "library/node"
      docker_image_tag: "22"
      execute_commands:
        - export XENDIT_COMPONENTS_TARGET_ENV="PRODUCTION"
        - export XENDIT_COMPONENTS_PINNING_KEYS="$IFRAME_PINNING_KEYS"
        - export XENDIT_COMPONENTS_SECURE_IFRAME_URL="https://assets.xendit.co/components/secure-iframe-$BUDDY_EXECUTION_TAG.html"
        - export XENDIT_COMPONENTS_VERSION="$BUDDY_EXECUTION_TAG"
        - "npm install -g pnpm"
        - "pnpm install"
        - "pnpm build"
        # rename files with tag suffix
        - "cp secure-iframe/dist/secure-iframe.html secure-iframe/dist/secure-iframe-$BUDDY_EXECUTION_TAG.html"
        - "cp action-landing-iframe/dist/action-landing-iframe.html action-landing-iframe/dist/action-landing-iframe-$BUDDY_EXECUTION_TAG.html"
      volume_mappings:
        - "/:/buddy/xendit-components-web"
      shell: "BASH"
    - action: "Upload SDK files to Amazon S3"
      type: "AMAZON_S3"
      input_type: "BUILD_ARTIFACTS"
      local_path: "sdk/dist/"
      remote_path: "/prod-live/components/$BUDDY_EXECUTION_TAG/"
      bucket_name: "xendit-checkout-assets"
      acl: "PRIVATE"
      integration_hash: "5e85761fc5f225000f97dd99"
      deletion_disabled: true
    - action: "Upload secure iframe file to Amazon S3"
      type: "AWS_CLI_2"
      region: "ap-southeast-1"
      input_type: "BUILD_ARTIFACTS"
      execute_commands:
        - "export DYNAMIC_CSP_HASH=$(cat secure-iframe/dist/js-hash.txt)"
        - "aws s3 cp secure-iframe/dist/secure-iframe-$BUDDY_EXECUTION_TAG.html s3://xendit-checkout-assets/prod-live/components/ --metadata csp-hash=$DYNAMIC_CSP_HASH --acl private"
      integration_hash: "5e85761fc5f225000f97dd99"
      deletion_disabled: true
    - action: "Upload landing iframe file to Amazon S3"
      type: "AWS_CLI_2"
      region: "ap-southeast-1"
      input_type: "BUILD_ARTIFACTS"
      execute_commands:
        - "aws s3 cp action-landing-iframe/dist/action-landing-iframe-$BUDDY_EXECUTION_TAG.html s3://xendit-checkout-assets/prod-live/components/ --cache-control no-cache --acl private"
      integration_hash: "5e85761fc5f225000f97dd99"
      deletion_disabled: true
    - action: "Deployment finished notif"
      type: "SLACK"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME Finished execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
      channel: "C09L26WCB4J"
      channel_name: "buddy-ci-payment-interface"
      attachments:
        - '{"fallback":"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID","color":"good","fields":[{"title":"Successful execution","value":"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>","short":true},{"title":"Pipeline","value":"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>","short":true},{"title":"Tag","value":"$BUDDY_EXECUTION_TAG","short":true},{"title":"Project","value":"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>","short":true}]}'
      trigger_condition: "ALWAYS"
      integration_hash: "5ea6524a42eba4000eb35fbb"
    - action: "Deployment failed notif"
      type: "SLACK"
      trigger_time: "ON_FAILURE"
      content: "[#$BUDDY_EXECUTION_ID] $BUDDY_PIPELINE_NAME Failed execution by <$BUDDY_INVOKER_URL|$BUDDY_INVOKER_NAME>"
      channel: "C09L26WCB4J"
      channel_name: "buddy-ci-payment-interface"
      attachments:
        - '{"fallback":"$BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID","color":"danger","fields":[{"title":"Failed execution","value":"<$BUDDY_EXECUTION_URL|Execution #$BUDDY_EXECUTION_ID $BUDDY_EXECUTION_COMMENT>","short":true},{"title":"Pipeline","value":"<$BUDDY_PIPELINE_URL|$BUDDY_PIPELINE_NAME>","short":true},{"title":"Tag","value":"$BUDDY_EXECUTION_TAG","short":true},{"title":"Project","value":"<$BUDDY_PROJECT_URL|$BUDDY_PROJECT_NAME>","short":true}]}'
      trigger_condition: "ALWAYS"
      integration_hash: "5ea6524a42eba4000eb35fbb"
